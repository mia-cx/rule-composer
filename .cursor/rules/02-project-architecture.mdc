---
description: Project structure, entry points, and module relationships for rule-composer
alwaysApply: true
---

# Project Architecture

Two subcommands (`compose`, `decompose`) sharing modules in `scripts/shared/`.

```
scripts/index.ts           → flag parser + subcommand router (compose [path] [-o out] | decompose [path] [-o out])
scripts/compose/index.ts   → orchestration: [input?] → scan → select → reorder → compose → optimize → [-o?] write → variants
scripts/decompose/index.ts → orchestration: [input?] → detect → pick → split → select → numbered → placeholder → format → [-o?] write
scripts/shared/            → types, schemas, formats, scanner, openrouter, cli, tree-prompt
```

Both subcommands accept an optional `[path]` argument (file or directory) that skips auto-detection, and `--output`/`-o` to skip the interactive output prompt. Paths ending with `/` are treated as directory targets.

## Key boundaries

- **Orchestration** (`compose/index.ts`, `decompose/index.ts`) — wires modules together, handles user interaction.
- **Pure logic** (`composer.ts`, `splitter.ts`, `matcher.ts`) — no I/O, no prompts, fully testable.
- **I/O adapters** (`formats.ts`: `readRule`, `writeAsSingleFile`, `writeAsDirectory`) — thin wrappers around `fs`. No formatting, no placeholder resolution.
- **Formatting** happens at the orchestration layer via `formatMarkdown()`, not inside write functions. This keeps unit tests unaffected.

## Section ordering & numbering

- **Compose**: `compose()` increments all heading levels by one per-section (H1 → H2, H2 → H3, etc.) by default to avoid multiple H1s in the combined output (`incrementHeadings` option, default `true`). Scoped rules (`alwaysApply: false`) get a `> [!globs] patterns...` callout injected after the first heading (`embedGlobs` option, default `true`). Users can also reorder selected rules (step 3.5) and add numbered prefixes to H2 headings via `addSectionNumbers()` (step 4.5). Both are optional toggles.
- **Decompose**: `extractGlobAnnotation()` detects `> [!globs]` callouts in split content and extracts the glob patterns and `alwaysApply: false` flag back into frontmatter via `buildRawContent()`. `unquoteGlobs()` reverses `quoteGlobs()` so Cursor sees native unquoted `globs:` values. `stripHeadingNumber()` removes `N. ` prefixes from H2 headings in both filename and content. `writeAsDirectory({ numbered: true })` prefixes filenames with zero-padded indices (`01-`, `02-`).

## Data flow

`RuleFile` is the core data type — everything reads into it and writes from it. `compose()` takes `RuleFile[]` and returns a string. `splitByHeadings()` returns `SplitResult[]` which the orchestrator converts to `RuleFile[]`.

## Conventions

- Keep interactive prompts in `cli.ts` or orchestration files, not in shared modules.
- Call `formatMarkdown` at the orchestration layer, not inside `writeAsSingleFile` / `writeAsDirectory`.
